# KAI System Identity (Architecture V3.0)

> 本文档说明 KAI 的**人设与调度机制**，技术实现细节请参考 `README.md`

> **Version**: 3.3 | **更新日期**：2026-01-08

## 一、核心定位

你是 KAI，主理人的**知识调度中枢**。

- **身份**：你不是一个只会聊天的 AI，你是一个拥有"技能库"的执行内核。
- **任务**：接收主理人的指令，**动态选择**最合适的 `.md` 技能模块，并结合 `knowledge_base` (Room B) 的记忆，输出高通过率的内容。
- **原则**：严守指令，精准调用，不随意发挥。

## 二、KAI 内容同步架构 V3.0

> 2026-01-08 更新：新增视频号逐字稿分析和 PDF 全文提取能力

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           KAI 内容同步中枢 V3.0                               │
├───────────────┬───────────────┬───────────────────────┬─────────────────────┤
│   飞书多维表   │   视频号      │        PDF            │       手动          │
│   自动同步     │   AI 拆解     │     全文提取          │      丢进 inbox    │
├───────────────┼───────────────┼───────────────────────┼─────────────────────┤
│ douyin/       │ douyin/       │ library/              │ 任意文件夹          │
│ xiaohongshu/  │               │ Full_xxx.md           │                     │
│ wechat/       │               │                       │                     │
└───────┬───────┴───────┬───────┴───────────┬───────────┴─────────────┬───────┘
        │               │                   │                           │
        ▼               ▼                   ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          KAI_Brain/00-Inbox/                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐  │
│  │ xiaohongshu │  │   wechat    │  │   douyin    │  │     library       │  │
│  │ (小红书)    │  │  (公众号)   │  │ (抖音+视频号) │  │   (PDF全文)       │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └───────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流说明

| 来源 | 触发方式 | 处理脚本 | 输出路径 | 特点 |
|------|----------|----------|----------|------|
| **飞书多维表** | `Sync_Trigger=True` | `sync_feishu_final.py` | `00-Inbox/{platform}/` | 自动同步 |
| **视频号文案** | 贴给 KAI + "处理视频号逐字稿" | `05_Video_Analyze.md` | `00-Inbox/douyin/` | AI 拆解 |
| **PDF** | 丢入 `pdf_temp/` | `scan_library.py` | `library/Full_xxx.md` | GLM-4.6 全文 |

### 2.3 同步机制详解

#### 飞书多维表同步 (`sync_feishu_final.py`)

```
多维表记录 → 检查 Sync_Trigger=True → 检查 Sync_Status≠已同步
     → 获取内容字段 → 清洗/格式化 → 保存 MD → 更新 Sync_Status=已同步
```

**支持的字段映射：**

| 平台 | 内容字段 | 文件名来源 | 特殊处理 |
|------|----------|------------|----------|
| 小红书 | `MD_Content` | title / 首句 | 清洗格式 + 注入元数据 |
| 公众号 | `MD_Content` | title / 首句 | 清洗格式 + 注入元数据 |
| 抖音 | `Output` | `FileName` 字段 | 直接保存，无需清洗 |

#### 视频号逐字稿拆解 (`05_Video_Analyze.md`)

```
视频号文案 → 触发 Skill → DeepSeek-R1 深度拆解 → 写入 douyin/
     │
     ├── 第一部分：🎭 逐字稿复盘（语气标注、金句高光）
     └── 第二部分：🧠 知识框架提炼（逻辑结构、行动建议）
```

#### PDF 全文提取 (`scan_library.py`)

```
pdf_temp/ → pdfplumber 提取 → GLM-4.6 排版 → library/Full_xxx.md
     │
     ├── 纯文字 PDF：直接提取，修复断行
     ├── 扫描版 PDF：OCR 识别（pytesseract）
     └── 超过 8 万字：自动截断前 8 万字
```

**使用方式：**
```bash
# 处理 pdf_temp/ 下的所有 PDF
python3 scripts/scan_library.py

# 处理完成后自动归档原文件到 pdf_archive/
```

## 三、动态调度机制 (The Router)

在回答前，先扫描 `prompts/` 下所有文件的 YAML 头部标签，进行 `<Strategy>` 决策：

### 3.1 优先级判断

| 层级 | 类型 | 文件 | 触发条件 |
|------|------|------|----------|
| **L2** | 认知工具 | `02_business_hypothesis.md` | 用户意图明确，涉及"评估、分析、验证" |
| **L1** | 交互流 | `01_task_decomposition.md` | 用户意图模糊，需要策划、梳理思路 |
| **L0** | 兜底 | `00_basic_thinking.md` | 通用问答，无特定模型可用 |

### 2.2 调度原则

- **L2 优先**：能用工具解决的不进入长流程
- **L1 接管**：进入后主导对话，直到产出方案
- **L0 兜底**：PREP 思维模型 + 记忆检索

## 三、Skill 模块说明

### 3.1 文件结构

```
prompts/
├── 00_basic_thinking.md        # 基础思维兜底 (L0)
├── 01_task_decomposition.md    # 任务分解与追问专家 (L1)
├── 02_business_hypothesis.md   # 业务假设分析师 (L2)
└── 03_decision_roi.md          # 科学决策 ROI 评估师
```

### 3.2 模块标签规范

每个 Skill 文件需包含 YAML 头部：

```yaml
---
type: 类型 (Interaction_Flow / Cognitive_Tool)
layer: L0/L1/L2
interaction_mode: Session_Based / One_Shot
risk_level: Low / Medium / High
trigger_condition:
  - 触发关键词/场景
conflict_rule:
  - 互斥规则
---
```

### 3.3 Skill 功能说明

| 模块 | 核心能力 | 输出形式 |
|------|----------|----------|
| `00_basic_thinking` | PREP 思维模型，定义→观点→支撑→行动 | 单次回复 |
| `01_task_decomposition` | 四步工作流：解构→诊断→开发→交付 | 多轮对话 |
| `02_business_hypothesis` | ROI 三角模型：宽度×深度×高度 | 单次分析 |
| `03_decision_roi` | 决策建议：Go / No-Go / 缓一缓 | 评估报告 |

## 四、记忆融合机制

在执行任何 Prompt 时，必须：

1. **扫描** `./knowledge_base` (Room B) 目录
2. **检索** 与当前话题相关的事实、案例、数据
3. **注入** 将主理人的原话/原逻辑作为素材填充

### 检索优先级

- 风格偏好（如《4000字复盘》的语感）
- 思维模型（PDCA、黄金圈、漏斗模型）
- 业务教训（选品坑、供应链翻车案例）

## 五、风格底线

- **语感**：理性、有温度、短句为主，像 35 岁职场老兵
- **词汇**：拧巴、颗粒度、交付、体感、闭环
- **禁止**：首先/其次/综上所述、作为一个AI
- **提倡**：反问句、Meta-Case 思维

## 六、测试记录

### 6.1 端到端测试 (2026-01-06)

| 测试场景 | 预期行为 | 结果 |
|----------|----------|------|
| L2 测试："帮我评估银发游学业务" | 直接调用业务假设分析，跳过模糊追问 | ✅ |
| L1 测试："帮我策划银发避坑文章" | 进入多轮对话，引导澄清需求 | ✅ |

### 6.2 待补充测试

- [ ] L0 基础问答测试
- [ ] 记忆检索准确性测试
- [ ] 多 Skill 组合调用测试

---

## 七、文档分工约束

> 新增内容时请参照以下规则，决定写入哪个文档

| 文档 | 内容类型 | 关键词 |
|------|----------|--------|
| **`README.md`** | 技术实现细节、脚本使用、部署流程、架构图、飞书同步规范 | 安装、配置、脚本、API、依赖、RAG |
| **`项目文档.md`** | KAI 人设、调度逻辑、Skill 模块设计、Prompt 模板 | 系统身份、动态调度、Prompts、记忆融合 |
| **`prompts/*.md`** | 可复用的技能模块（Prompt） | Skill、模块、专家、分析师 |
| **`knowledge_base/`** | 主理人的知识资产（从飞书同步） | 复盘、案例、方法论、洞察 |

### 7.1 判断流程

```
新增内容?
    │
    ├── 涉及"AI 怎么思考/响应" → 项目文档.md
    ├── 涉及"脚本怎么写/系统怎么跑" → README.md
    ├── 涉及"具体技能 Prompt" → prompts/xx_xxx.md
    └── 涉及"主理人的知识/经验" → knowledge_base/ (或飞书同步)
```

### 7.2 示例

| 新增内容 | 应写入 |
|----------|--------|
| 新增一个"文案写作"Skill | `prompts/04_copywriting.md` |
| 调整 KAI 的调度优先级规则 | `项目文档.md` |
| 添加飞书 Block 类型映射规则 | `README.md` |
| 同步一篇新的复盘文章 | 飞书云文档 (自动同步至 `knowledge_base/`) |

### 7.3 序号顺延规则

当新增的 Prompt 序号与现有文件冲突时，**自动顺延到下一个可用序号**：

```python
# 伪代码逻辑
new_number = requested_number
while f"prompts/{new_number:02d}_*.md" exists:
    new_number += 1
```

**示例**：
- 请求 `01_xxx.md` 但已存在 → 创建 `05_xxx.md`
- 请求 `03_xxx.md` 但已存在 → 创建 `05_xxx.md`

**当前序号占用情况**（截至 2026-01-08）：
| 序号 | 文件 | 层级 | 代号 |
|------|------|------|------|
| 00 | `00_Basic_Chat.md` | L0 | ☕ 陪练搭子 |
| 01 | `01_Task_Decompose.md` | L1 | 🧱 拆解大师 |
| 02 | `02_Biz_Hypothesis.md` | L2 | 🕵️ 商业侦探 |
| 03 | `03_ROI_Calculator.md` | L2 | 💰 铁血 CFO |
| 04 | `04_Course_Design.md` | L1 | 📚 课程设计 |
| 05 | `05_Demand_Verify.md` | L1 | 🎯 需求验证 |
| 06 | `06_Video_Analyze.md` | L2 | 🎬 视频拆解（视频号逐字稿） |

**下一个可用**：07

> 💡 使用提示：输入 `@` 呼出文件列表，输入 `@01` 或 `@Task` 可快速定位。详见 `prompts/000_KAI_Menu.md`

---

## 八、Outputs 输出规范

### 8.1 实时输出规则

每次 L1/L2 Skill 模块交付成果时，**必须同步生成一个 `.md` 文件**到 `outputs/` 目录：

| 触发场景 | 输出文件 |
|----------|----------|
| L1 完成多轮对话，产出方案 | `outputs/YYYYMMDD_HHMM_主题方案.md` |
| L2 完成单次分析，产出报告 | `outputs/YYYYMMDD_HHMM_主题分析.md` |
| L0 产出结构化建议 | `outputs/YYYYMMDD_HHMM_主题建议.md` |

### 8.2 文件命名格式

```
YYYYMMDD_HHMM_{主题关键词}.md
```

**示例**：
- `outputs/20260106_1030_银发游学评估.md`
- `outputs/20260106_1045_银发避坑文章策划.md`

### 8.3 输出内容要求

文件必须包含：
1. **对话摘要** - 本次讨论的核心问题
2. **关键结论** - 产出的主要观点
3. **待办项** - 下一步 action
4. **原始对话** - 可选，完整对话记录

### 8.4 协作流程

```
对话中
    │
    ├── L1/L2 模块交付成果
    │
    └── 立即写入 outputs/*.md
              │
              ├── 用户可二次加工
              └── KAI 可作为记忆锚点回溯
```

### 8.5 当前 Outputs 结构

```
outputs/
├── 20260106_0106_如何提升个人能力.md
├── 20260106_0109_基于我做视频号带货和.md
└── ...
```

---

## 九、Skill 更新记录

### 9.1 新增 Skill

| 日期 | 序号 | 文件 | 描述 |
|------|------|------|------|
| 2026-01-07 | 05 | `05_Demand_Verify.md` | 梁宁真需求验证系统 |
| 2026-01-08 | 06 | `06_Video_Analyze.md` | 视频号逐字稿分析（DeepSeek-R1） |

### 9.2 同步脚本更新

| 日期 | 脚本 | 更新内容 |
|------|------|----------|
| 2026-01-08 | `scripts/build_index.py` | V3.3 混合切分策略（标题+递归切分） |
| 2026-01-08 | `scripts/scan_library.py` | V3.4 PDF 全文提取（集成文本检测） |
| 2026-01-08 | `scripts/check_pdf_text.py` | 新增 PDF 文本图层检测工具 |
| 2026-01-08 | `sync_feishu_final.py` | 新增抖音平台支持（raw_mode） |
| 2026-01-08 | `scan_library.py` | PDF 全文提取 v3.0，GLM-4.6 排版 |

### 9.3 V3.3 切分策略 (Chunking Strategy)

**问题背景**：
- ❌ 旧策略：按字符数切分（如每 500 字），会腰斩完整段落
- ✅ 新策略：基于 Markdown 结构的递归切分

**混合切分流程**：
```
Markdown 文档
    │
    ├── 第一层：MarkdownHeaderTextSplitter
    │       按 # / ## / ### 标题切分
    │       → 保留 Header 1/2/3 元数据
    │
    └── 第二层：RecursiveCharacterTextSplitter
            按段落和句子细切
            → chunk_size=500, chunk_overlap=50
```

**元数据增强**：
```yaml
metadata:
  source: 文件名.md
  filepath: /path/to/file.md
  Header 1: 第一章 标题
  Header 2: 1.1 小节标题
  Header 3: 1.1.1 子节标题
```

### 9.4 PDF 质量约束

**约束规则**：
- PDF 进入 `pdf_temp/` 前先检测文本图层
- 全图片 PDF（无可提取文本）自动拦截
- 错误信息：`全图片PDF，禁止入库`

**检测脚本**：
```bash
# 检查 pdf_temp 中所有 PDF
python3 scripts/check_pdf_text.py

# 检查单个文件
python3 scripts/check_pdf_text.py /path/to/file.pdf
```

**输出示例**：
```
✅ 文件名.pdf 包含文本图层 (16886 字)
❌ 扫描版教材.pdf 是全图片PDF，禁止入库
```

### 9.5 V3.3 Rerank 重排序

**问题背景**：
- ❌ 向量检索只看"长得像不像"，可能返回无关内容
- ✅ Rerank 用交叉编码器精排，提升检索质量

**流程**：
```
用户问题
    │
    ├── 粗排：向量检索 Top-20
    │       └── 模型：shibing624/text2vec-base-chinese
    │
    └── 精排：Rerank 打分排序
            └── 模型：BAAI/bge-reranker-v2-m3
            └── 输出：Top-5
```

**配置参数**：
| 参数 | 值 | 说明 |
|------|-----|------|
| RERANK_ENABLED | True | 是否启用 |
| RERANK_MODEL | BAAI/bge-reranker-v2-m3 | 模型名称 |
| RERANK_TOP_K | 20 | 粗排候选数 |
| RERANK_TOP_N | 5 | 精排结果数 |

**依赖**：
```bash
pip3 install FlagEmbedding
```

**效果示例**：
| 阶段 | 问"GVM 公式" |
|------|--------------|
| 粗排 Top-5 | 包含 G、V、M 字母的无关段落排第1 |
| 精排 Top-5 | GVM 公式定义排第1 |

### 9.6 待补充测试

- [ ] 05 需求验证系统完整流程测试
- [ ] 06 视频拆解与逐字稿分析测试
- [ ] V3.3 切分策略检索效果测试
- [ ] V3.3 Rerank 精排效果测试

---

## 十、风险检查清单 (Migration Checklist)

> 每次目录重构或迁移前，必须逐项检查。

### 10.1 必检项清单

| 类别 | 检查项 | 工具/命令 |
|------|--------|-----------|
| **配置路径** | `.env` 文件位置是否正确 | `grep "load_dotenv" scripts/*.py` |
| **脚本路径** | 脚本内的硬编码路径 | `grep -rn "knowledge_base\|outputs\|scripts" scripts/*.py` |
| **索引输出** | `gen_index.py` 的 `OUTPUT_FILE` 路径 | 检查第 9 行 |
| **State 文件** | `.sync_state.json` 是否会被误删 | 检查 `sync_all.py --full` 逻辑 |
| **文档同步** | `docs_list.txt` 是否在正确位置 | 确认路径引用 |
| **Prompt 引用** | `prompts/*.md` 内的路径注释 | 手动检查 |

### 10.2 典型风险案例

#### 案例：config/.env 路径问题 (2026-01-06)

**症状**：
- 同步脚本运行正常，但文档标题全部显示为 "untitled"
- API 能正常返回标题，但脚本读取失败

**根因**：
- `load_dotenv()` 默认查找 `./.env`
- 配置文件在 `config/.env`，未被加载
- 脚本从 state.json 读取缓存的 "untitled" 标题

**修复**：
```python
# 修复前
load_dotenv()

# 修复后
load_dotenv(os.path.join(os.path.dirname(os.path.dirname(__file__)), 'config', '.env'))
```

**教训**：
- ✅ 检查环境变量加载时，确认 `.env` 文件的实际位置
- ✅ 不要假设默认路径，总是显式指定

### 10.3 迁移操作清单

当需要移动目录时，按以下顺序执行：

1. **备份**
   ```bash
   git add -A && git commit -m "备份：迁移前状态"
   ```

2. **检查依赖**
   ```bash
   grep -rn "旧目录名" scripts/*.py prompts/*.py .cursorrules
   ```

3. **修改路径**（逐个文件修改）

4. **验证同步**
   ```bash
   python3 scripts/sync_all.py
   ```

5. **检查索引**
   ```bash
   python3 scripts/gen_index.py
   cat knowledge_base_index.md | head -5
   ```

6. **提交**
   ```bash
   git add -A && git commit -m "重构：目录迁移"
   ```

---

## 十一、脚本管理规范

### 11.1 当前脚本结构

```
根目录/
├── sync_feishu_final.py   # 多平台同步（小红书/公众号/抖音）
│
scripts/
├── scan_library.py        # PDF 全文提取（GLM-4.6）
├── check_pdf_text.py      # PDF 文本图层检测
├── sync_all.py            # 飞书云文档同步（归档）
├── gen_index.py           # 索引生成
├── build_index.py         # 向量化
├── ask_kai.py             # RAG 问答
└── legacy/                # 已归档脚本
    ├── sync_kai_atoms.py  # OOP 版本飞书同步
    ├── scan_library.py.v3.3.bak
    └── ...
```

### 11.2 脚本功能矩阵

| 脚本 | 功能 | 使用频率 | 维护状态 |
|------|------|----------|----------|
| `sync_feishu_final.py` | 多平台（小红书/公众号/抖音）同步 | ⭐⭐⭐ 常用 | ✅ 活跃 |
| `scripts/scan_library.py` | PDF 全文提取（GLM-4.6） | ⭐⭐ 一般 | ✅ 活跃 |
| `scripts/check_pdf_text.py` | PDF 文本图层检测 | ⭐⭐ 一般 | ✅ 活跃 |
| `scripts/sync_all.py` | 飞书云文档同步 | ⭐ 归档 | ⚠️ 归档 |
| `scripts/gen_index.py` | 知识库索引生成 | ⭐⭐ 一般 | ✅ 维护 |
| `scripts/build_index.py` | 向量化存储 | ⭐ 定期 | ✅ 维护 |
| `scripts/ask_kai.py` | RAG 问答 + Rerank 精排 | ⭐⭐ 一般 | ✅ V3.3 更新 |

### 11.3 脚本状态定义

| 状态 | 定义 | 操作 |
|------|------|------|
| ✅ 活跃 | 主流程脚本，正在使用 | 保留，维护更新 |
| ⚠️ 归档 | 功能已迁移或废弃 | 移至 `legacy/` 备查 |
| ❌ 删除 | 完全无用、泄密风险 | 直接删除 |

### 11.3 清理记录

| 日期 | 归档脚本 | 原因 |
|------|----------|------|
| 2026-01-08 | `scan_library.py` (旧版) | 升级到 V3.4，移至 legacy |
| 2026-01-07 | `sync_kai_atoms.py` | 功能被 `sync_all.py` 替代 |
| 2026-01-07 | `check_docs.py` | 早期调试脚本，已无需使用 |
| 2026-01-07 | `clean_markdown.py` | 早期格式清理，已无需使用 |
| 2026-01-07 | `test_tokens.py` | Token 测试脚本，一次性使用 |

### 11.4 清理审批流程

```
发现可清理脚本?
    │
    ├── 分析脚本功能
    │
    ├── 确认无活跃依赖
    │   ├── grep "脚本名" *.py prompts/*.md .cursorrules
    │   └── 检查 crontab / CI/CD
    │
    ├── 移至 legacy/（不直接删除）
    │   mkdir -p scripts/legacy/
    │   mv scripts/xxx.py scripts/legacy/
    │
    └── 记录到项目文档.md 第11节
```

### 11.5 恢复旧脚本

如需恢复已归档脚本：

```bash
mv scripts/legacy/xxx.py scripts/
```

> 📌 **提示**：保留在 `legacy/` 目录的脚本可能包含可复用的代码片段，清理时快速浏览一眼。
